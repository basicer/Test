{
	"_id": "56250e286dd26686053edcc7",
	"slug": "strandedinthedunesreferee",
	"searchStrings": "stranded in the dunes referee s st str stra stran strand strande stranded strandedi strandedin strandedint strandedinth strandedinthe strandedinthed strandedinthedu strandedinthedun strandedinthedune strandedinthedunes strandedinthedunesr strandedinthedunesre strandedinthedunesref strandedinthedunesrefe strandedinthedunesrefer",
	"name": "StrandedInTheDunesReferee",
	"js": "var StrandedInTheDunesReferee, _ref,\n  __hasProp = {}.hasOwnProperty,\n  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };\n\nStrandedInTheDunesReferee = (function(_super) {\n  __extends(StrandedInTheDunesReferee, _super);\n\n  function StrandedInTheDunesReferee() {\n    _ref = StrandedInTheDunesReferee.__super__.constructor.apply(this, arguments);\n    return _ref;\n  }\n\n  StrandedInTheDunesReferee.className = 'StrandedInTheDunesReferee';\n\n  StrandedInTheDunesReferee.prototype.chooseAction = function() {\n    this.configure();\n    this.checkActorEvents();\n    this.decrementTimers();\n    this.jibberJabber();\n    this.resetGravity();\n    this.cleanUpYaks();\n    this.fixUnitAggro();\n    this.handleLevelWrap();\n    this.checkRaven();\n    this.checkPotions();\n    this.sectorPulse();\n    return this.bossEncounter();\n  };\n\n  StrandedInTheDunesReferee.prototype.setUpLevel = function() {\n    var actor, name, _ref1;\n    this.hero = this.world.getThangByID('Hero Placeholder');\n    this.disableEnemies = false;\n    this.actors = {\n      \"elder\": this.world.getThangByID('Village Elder'),\n      \"son\": this.world.getThangByID('Elder\\'s Son'),\n      \"yakky\": this.world.getThangByID('Yakky'),\n      \"hector\": this.world.getThangByID('Hector'),\n      \"durfkor\": this.world.getThangByID('Durfkor'),\n      \"katelyn\": this.world.getThangByID('Katelyn'),\n      \"mary\": this.world.getThangByID('Mary'),\n      \"raven\": this.world.getThangByID('Raven')\n    };\n    this.actorEvents = {\n      \"elder-intro-move\": false,\n      \"raven-spawned\": false,\n      \"raven-start-positioning\": false,\n      \"raven-positioning\": false,\n      \"raven-positioned\": false,\n      \"raven-swoop-start\": false,\n      \"raven-swoop-progress\": false,\n      \"raven-swoop-return\": false\n    };\n    _ref1 = this.actors;\n    for (name in _ref1) {\n      actor = _ref1[name];\n      actor.isAttackable = false;\n    }\n    this.potionRegistry = [];\n    this.terrainObjects = [\"desert-wall-1\", \"desert-wall-2\", \"desert-wall-3\", \"desert-wall-4\", \"desert-wall-5\", \"desert-wall-6\", \"desert-wall-7\", \"desert-wall-8\", \"desert-rubble-1\", \"desert-rubble-2\", \"desert-bones-1\", \"desert-bones-2\", \"desert-bones-3\", \"scorpion\", \"snake\"];\n    this.terrainCleanupObjects = [\"desert-wall-1\", \"desert-wall-2\", \"desert-wall-3\", \"desert-wall-4\", \"desert-wall-5\", \"desert-wall-6\", \"desert-wall-7\", \"desert-wall-8\", \"desert-house-1\", \"desert-house-2\", \"desert-house-3\", \"desert-house-4\", \"desert-well\", \"desert-rubble-1\", \"desert-rubble-2\", \"desert-rubble-3\", \"desert-palm-1\", \"desert-palm-2\", \"desert-green-1\", \"desert-green-2\", \"desert-pillar\", \"desert-skullcave\", \"desert-pyramid\", \"desert-bones-1\", \"desert-bones-2\", \"desert-bones-3\", \"desert-shrub-big-1\", \"desert-shrub-big-2\", \"scorpion\", \"snake\", \"fire-trap\"];\n    this.events = [\"melee-skeletons\", \"shaman-skeletons\", \"archer-skeletons\"];\n    this.eventOdds = {\n      \"sand-yaks\": 60,\n      \"melee-skeletons\": 90,\n      \"shaman-skeletons\": 95,\n      \"archer-skeletons\": 95\n    };\n    this.timers = {\n      \"wrapTimer\": 0,\n      \"eventTimer\": 0,\n      \"sandYakTimer\": 0,\n      \"bossDelay\": 0,\n      \"bossfall\": 0,\n      \"swoopDelay\": 0\n    };\n    this.bossEvents = {\n      \"started\": false,\n      \"spawned\": false,\n      \"fallen\": false,\n      \"dialog1\": false,\n      \"dialog2\": false,\n      \"moving\": false,\n      \"positioned\": false,\n      \"wave1\": false,\n      \"taunt1\": false,\n      \"wave2\": false,\n      \"wave2_2\": false,\n      \"wave2_3\": false,\n      \"taunt2\": false\n    };\n    this.leftWrapPending = false;\n    this.rightWrapPending = false;\n    this.numberOfEvents = 3;\n    this.totalStacksBeforeBoss = 3;\n    this.maxNumTerrainObjects = 24;\n    this.maxNumFireTraps = 12;\n    this.bossStackGenerated = false;\n    return this.currentNumPotions = 0;\n  };\n\n  StrandedInTheDunesReferee.prototype.configure = function() {\n    if (!!this.configured) {\n      return;\n    }\n    this.currentStack = 0;\n    this.terrainStack = [\n      [\n        {\n          obj: \"desert-wall-1\",\n          x: 41.59,\n          y: 54.800000000000004\n        }, {\n          obj: \"desert-wall-1\",\n          x: 31.45,\n          y: 47.76\n        }, {\n          obj: \"desert-wall-1\",\n          x: 12.05,\n          y: 49.63\n        }, {\n          obj: \"desert-wall-2\",\n          x: 32.09,\n          y: 67.88\n        }, {\n          obj: \"desert-wall-2\",\n          x: 21.8,\n          y: 56.32\n        }, {\n          obj: \"desert-wall-2\",\n          x: 30.59,\n          y: 3.53\n        }, {\n          obj: \"desert-wall-2\",\n          x: -4.540000000000001,\n          y: 46.17,\n          r: 3.141592653589793\n        }, {\n          obj: \"desert-wall-2\",\n          x: -1.7200000000000006,\n          y: 37.2,\n          r: 3.141592653589793\n        }, {\n          obj: \"desert-wall-2\",\n          x: -5.52,\n          y: 29.98,\n          r: 3.141592653589793\n        }, {\n          obj: \"desert-wall-2\",\n          x: -2.5600000000000005,\n          y: 22.87,\n          r: 3.141592653589793\n        }, {\n          obj: \"desert-wall-3\",\n          x: 58.92,\n          y: 16.67\n        }, {\n          obj: \"desert-wall-4\",\n          x: 10.41,\n          y: 66\n        }, {\n          obj: \"desert-wall-4\",\n          x: 10.53,\n          y: 3.82\n        }, {\n          obj: \"desert-wall-4\",\n          x: 49.88,\n          y: -0.3700000000000001\n        }, {\n          obj: \"desert-wall-5\",\n          x: 55.67,\n          y: 58.15\n        }, {\n          obj: \"desert-wall-6\",\n          x: 5.11,\n          y: 57.58,\n          r: 0.52\n        }, {\n          obj: \"desert-wall-7\",\n          x: 49.02,\n          y: 45.59\n        }, {\n          obj: \"desert-wall-7\",\n          x: 9.16,\n          y: 42.4\n        }, {\n          obj: \"desert-wall-7\",\n          x: 56.21,\n          y: 7.140000000000001\n        }, {\n          obj: \"desert-wall-8\",\n          x: 51.29,\n          y: 65.45\n        }, {\n          obj: \"desert-wall-8\",\n          x: -3.030000000000001,\n          y: 11.77,\n          r: 3.141592653589793\n        }, {\n          obj: \"desert-wall-8\",\n          x: 68.46000000000001,\n          y: 67.69,\n          r: 3.141592653589793\n        }, {\n          obj: \"desert-house-1\",\n          x: 40.39,\n          y: 41.47,\n          r: 3.141592653589793\n        }, {\n          obj: \"desert-house-2\",\n          x: 12.13,\n          y: 35.38,\n          r: 0.78\n        }, {\n          obj: \"desert-house-2\",\n          x: 48.56,\n          y: 40,\n          r: 3.141592653589793\n        }, {\n          obj: \"desert-house-2\",\n          x: 14.97,\n          y: 13.03,\n          r: -1.5707963267948966\n        }, {\n          obj: \"desert-house-3\",\n          x: 21.35,\n          y: 41.74,\n          r: 0.78\n        }, {\n          obj: \"desert-house-3\",\n          x: 43.36,\n          y: 7.2,\n          r: 3.141592653589793\n        }, {\n          obj: \"desert-house-4\",\n          x: 7.71,\n          y: 28.78,\n          r: 0.78\n        }, {\n          obj: \"desert-house-4\",\n          x: 23.97,\n          y: 10.28,\n          r: 0.78\n        }, {\n          obj: \"desert-well\",\n          x: 8.07,\n          y: 17.3\n        }, {\n          obj: \"desert-rubble-3\",\n          x: 59.36,\n          y: 44.47\n        }, {\n          obj: \"desert-palm-1\",\n          x: 58.050000000000004,\n          y: 23.37\n        }, {\n          obj: \"desert-palm-2\",\n          x: 27.810000000000002,\n          y: 41.43\n        }, {\n          obj: \"desert-green-1\",\n          x: 58.81,\n          y: 40.71\n        }, {\n          obj: \"desert-green-1\",\n          x: 7.97,\n          y: 13.97\n        }, {\n          obj: \"desert-green-2\",\n          x: 36.7,\n          y: 41.15\n        }, {\n          obj: \"desert-green-2\",\n          x: 19.46,\n          y: 14.41\n        }, {\n          obj: \"desert-green-2\",\n          x: 11.44,\n          y: 31.17\n        }, {\n          obj: \"desert-pillar\",\n          x: 66.62,\n          y: 21.63\n        }, {\n          obj: \"desert-pillar\",\n          x: 60.77,\n          y: 41.72\n        }, {\n          obj: \"desert-pillar\",\n          x: 67.7,\n          y: 18.31\n        }, {\n          obj: \"desert-pillar\",\n          x: 74.68,\n          y: 25.29\n        }, {\n          obj: \"desert-pillar\",\n          x: 86.89,\n          y: 26.990000000000002\n        }, {\n          obj: \"desert-pillar\",\n          x: 98.59,\n          y: 26.990000000000002\n        }, {\n          obj: \"desert-pillar\",\n          x: 111.24000000000001,\n          y: 27.560000000000002\n        }, {\n          obj: \"desert-pillar\",\n          x: 71.7,\n          y: 46.49\n        }, {\n          obj: \"desert-pillar\",\n          x: 85.12,\n          y: 48.28\n        }, {\n          obj: \"desert-pillar\",\n          x: 98.44,\n          y: 47.92\n        }, {\n          obj: \"desert-pillar\",\n          x: 111.24000000000001,\n          y: 46.64\n        }\n      ]\n    ];\n    this.bossStack = [\n      {\n        obj: \"desert-wall-1\",\n        x: 30.34,\n        y: 15.39\n      }, {\n        obj: \"desert-wall-1\",\n        x: 90.26,\n        y: 14.84,\n        r: 3.141592653589793\n      }, {\n        obj: \"desert-wall-2\",\n        x: 31.89,\n        y: 43.2\n      }, {\n        obj: \"desert-wall-2\",\n        x: 88.72,\n        y: 43.010000000000005,\n        r: 3.141592653589793\n      }, {\n        obj: \"desert-wall-3\",\n        x: 45.49,\n        y: 13.46\n      }, {\n        obj: \"desert-wall-3\",\n        x: 73.94,\n        y: 13.75,\n        r: 3.141592653589793\n      }, {\n        obj: \"desert-wall-4\",\n        x: 23.380000000000003,\n        y: 34.19\n      }, {\n        obj: \"desert-wall-4\",\n        x: 97.24,\n        y: 34.25,\n        r: 3.141592653589793\n      }, {\n        obj: \"desert-wall-6\",\n        x: 16.4,\n        y: 43.42,\n        r: 0.52\n      }, {\n        obj: \"desert-wall-6\",\n        x: 15.69,\n        y: 61.75,\n        r: 0.52\n      }, {\n        obj: \"desert-wall-6\",\n        x: 104.28,\n        y: 61.71000000000001\n      }, {\n        obj: \"desert-wall-6\",\n        x: 104.4,\n        y: 43.46,\n        r: 3.141592653589793\n      }, {\n        obj: \"desert-wall-7\",\n        x: 28.07,\n        y: 55.15\n      }, {\n        obj: \"desert-wall-7\",\n        x: 35.22,\n        y: 48.08\n      }, {\n        obj: \"desert-wall-7\",\n        x: 26.86,\n        y: 22.400000000000002\n      }, {\n        obj: \"desert-wall-7\",\n        x: 92.74,\n        y: 55.36,\n        r: 3.141592653589793\n      }, {\n        obj: \"desert-wall-7\",\n        x: 85.58,\n        y: 48.07,\n        r: 3.141592653589793\n      }, {\n        obj: \"desert-wall-7\",\n        x: 93.68,\n        y: 22.11,\n        r: 3.141592653589793\n      }, {\n        obj: \"desert-wall-7\",\n        x: 19.62,\n        y: 51.4\n      }, {\n        obj: \"desert-wall-7\",\n        x: 101.06,\n        y: 51.43,\n        r: 3.141592653589793\n      }, {\n        obj: \"desert-skullcave\",\n        x: 55.89,\n        y: 51.99,\n        r: 0.78,\n        c: true\n      }, {\n        obj: \"desert-pyramid\",\n        x: 60.38,\n        y: 56.88,\n        r: 0.78\n      }, {\n        obj: \"desert-pillar\",\n        x: 51,\n        y: 54.95,\n        c: true\n      }, {\n        obj: \"desert-pillar\",\n        x: 65.35,\n        y: 49.18,\n        c: true\n      }, {\n        obj: \"desert-rubble-1\",\n        x: 70.26,\n        y: 54.230000000000004,\n        r: 0.78\n      }, {\n        obj: \"desert-rubble-2\",\n        x: 70.06,\n        y: 61.97\n      }, {\n        obj: \"desert-bones-1\",\n        x: 114.93,\n        y: 8.32\n      }, {\n        obj: \"desert-bones-2\",\n        x: 102.74000000000001,\n        y: 29.12\n      }, {\n        obj: \"desert-bones-2\",\n        x: 9.120000000000001,\n        y: 45.69\n      }, {\n        obj: \"desert-bones-3\",\n        x: 113.33,\n        y: 56.72\n      }, {\n        obj: \"desert-bones-3\",\n        x: 40.980000000000004,\n        y: 19.86\n      }, {\n        obj: \"desert-bones-3\",\n        x: 42.550000000000004,\n        y: 65.87\n      }, {\n        obj: \"desert-shrub-big-1\",\n        x: 13.84,\n        y: 28.11\n      }, {\n        obj: \"desert-shrub-big-1\",\n        x: 74.81,\n        y: 44.89\n      }, {\n        obj: \"desert-shrub-big-2\",\n        x: 112.67,\n        y: 41.35\n      }, {\n        obj: \"desert-shrub-big-2\",\n        x: 26.330000000000002,\n        y: 9.5\n      }\n    ];\n    this.stackSpawns = [0];\n    this.configureThangTemplates();\n    this.populateTerrain();\n    return this.configured = true;\n  };\n\n  StrandedInTheDunesReferee.prototype.configureThangTemplates = function() {\n    var btp;\n    btp = this.world.getSystem('Existence').buildTypePower;\n    btp['brittle-skeleton'] = 75.00;\n    btp['brittle-skeleton-shaman'] = 95.00;\n    return btp['brittle-skeleton-archer'] = 95.00;\n  };\n\n  StrandedInTheDunesReferee.prototype.configureStack = function() {\n    var actor, name, _ref1, _ref2;\n    this.cleanUpCorpses();\n    if (this.terrainStack.length - 1 === this.totalStacksBeforeBoss && !this.bossStackGenerated) {\n      this.bossStackGenerated = true;\n      this.populateTerrain(true);\n      this.spawnBossGuards();\n    } else {\n      this.populateTerrain();\n    }\n    if (this.currentStack === 0) {\n      _ref1 = this.actors;\n      for (name in _ref1) {\n        actor = _ref1[name];\n        actor.setExists(true);\n      }\n    } else {\n      _ref2 = this.actors;\n      for (name in _ref2) {\n        actor = _ref2[name];\n        actor.setExists(false);\n      }\n    }\n    return this.world.getSystem(\"AI\").onObstaclesChanged();\n  };\n\n  StrandedInTheDunesReferee.prototype.configureYak = function(yak) {\n    yak.maxSpeed = 20;\n    yak.currentSpeedRatio = 1;\n    yak.addTrackedProperties(['maxSpeed', 'number']);\n    yak.keepTrackedProperty('maxSpeed');\n    yak.addTrackedProperties(['currentSpeedRatio', 'number']);\n    return yak.keepTrackedProperty('currentSpeedRatio');\n  };\n\n  StrandedInTheDunesReferee.prototype.resetGravity = function() {\n    var potion, _i, _len, _ref1;\n    if (!(!this.bossEvents.spawned || this.timers.bossfall > 0 || this.skeletonKing.pos.z <= 0)) {\n      return;\n    }\n    _ref1 = this.potionRegistry;\n    for (_i = 0, _len = _ref1.length; _i < _len; _i++) {\n      potion = _ref1[_i];\n      if (potion.exists && potion.pos.z > 0) {\n        return;\n      }\n    }\n    return this.world.gravity = 9.81;\n  };\n\n  StrandedInTheDunesReferee.prototype.decrementTimers = function() {\n    var name, timer, _ref1, _results;\n    _ref1 = this.timers;\n    _results = [];\n    for (name in _ref1) {\n      timer = _ref1[name];\n      _results.push(this.timers[name] -= this.world.dt);\n    }\n    return _results;\n  };\n\n  StrandedInTheDunesReferee.prototype.checkActorEvents = function() {\n    if (this.world.age >= 0 && !this.actorEvents['elder-intro-move']) {\n      this.actors.elder.move({\n        x: 30,\n        y: 29\n      });\n      return this.actorEvents['elder-intro-move'] = true;\n    }\n  };\n\n  StrandedInTheDunesReferee.prototype.jibberJabber = function() {\n    var emote, emotes, now, _base, _i, _len, _results;\n    now = Math.round(this.world.age);\n    emotes = [\n      {\n        time: 0,\n        actor: this.actors.elder,\n        message: \"Please help me hero!\"\n      }, {\n        time: 4,\n        actor: this.actors.yakky,\n        message: \"Moo?\"\n      }, {\n        time: 6,\n        actor: this.actors.yakky,\n        message: \"Meow?\"\n      }, {\n        time: 8,\n        actor: this.actors.yakky,\n        message: \"Ribbit?\"\n      }\n    ];\n    _results = [];\n    for (_i = 0, _len = emotes.length; _i < _len; _i++) {\n      emote = emotes[_i];\n      if (now === emote.time) {\n        _results.push(typeof (_base = emote.actor).say === \"function\" ? _base.say(emote.message) : void 0);\n      } else {\n        _results.push(void 0);\n      }\n    }\n    return _results;\n  };\n\n  StrandedInTheDunesReferee.prototype.checkRaven = function() {\n    var _base, _base1;\n    if (this.currentStack > 0 && !this.bossStackGenerated) {\n      if (this.stackSpawns[this.currentStack] === 0 && !this.actorEvents[\"raven-spawned\"] && this.enemiesCleared()) {\n        this.actorEvents[\"raven-spawned\"] = true;\n        this.actors.raven.pos.x = this.hero.pos.x + 5;\n        this.actors.raven.pos.y = this.hero.pos.y + 5;\n        this.actors.raven.setExists(true);\n        return typeof (_base = this.actors.raven).say === \"function\" ? _base.say(\"Continue forward to find more skeletons!\") : void 0;\n      } else if (this.stackSpawns[this.currentStack] === 0 && this.actorEvents[\"raven-spawned\"]) {\n        return this.actors.raven.move(Vector.subtract(this.actors.raven.pos, this.hero.pos).normalize().multiply(7).add(this.hero.pos));\n      }\n    } else if (this.currentStack === this.terrainStack.length - 1 && this.bossStackGenerated) {\n      if (!this.actorEvents[\"raven-spawned\"]) {\n        this.actorEvents[\"raven-spawned\"] = true;\n        this.actors.raven.pos.x = this.hero.pos.x + 5;\n        this.actors.raven.pos.y = this.hero.pos.y + 5;\n        this.actors.raven.setExists(true);\n        return typeof (_base1 = this.actors.raven).say === \"function\" ? _base1.say(\"You are getting close now, investigate those ruins!\") : void 0;\n      } else if (this.actorEvents[\"raven-spawned\"] && !this.actorEvents[\"raven-start-positioning\"]) {\n        return this.actors.raven.move(Vector.subtract(this.actors.raven.pos, this.hero.pos).normalize().multiply(7).add(this.hero.pos));\n      }\n    }\n  };\n\n  StrandedInTheDunesReferee.prototype.ravenPerch = function() {\n    this.actors.raven.pos.z = 12;\n    this.actors.raven.rotation = 90;\n    this.actors.raven.velocity.multiply(0);\n    this.actors.raven.setAction(null);\n    return this.actors.raven.setTarget(null);\n  };\n\n  StrandedInTheDunesReferee.prototype.ravenMovement = function() {\n    var p;\n    if (this.actorEvents[\"raven-start-positioning\"] && !this.actorEvents[\"raven-positioned\"]) {\n      if (!this.actorEvents[\"raven-positioning\"]) {\n        if (this.actors.raven.pos.x !== 69 && this.actors.raven.pos.y !== 33) {\n          return this.actors.raven.moveXY(69, 33);\n        } else {\n          this.actorEvents[\"raven-positioning\"] = true;\n          return this.actors.raven.moveXY(51, 54);\n        }\n      } else if (this.actorEvents[\"raven-positioning\"]) {\n        if (this.actors.raven.pos.x === 51 && this.actors.raven.pos.y === 54 && !this.actorEvents[\"raven-positioned\"]) {\n          this.actorEvents[\"raven-positioned\"] = true;\n          return this.ravenPerch();\n        }\n      }\n    } else if (this.actorEvents[\"raven-swoop-start\"] && !this.actorEvents[\"raven-swoop-return\"] && !this.actorEvents[\"raven-return-village\"]) {\n      if (!this.actorEvents[\"raven-swoop-progress\"]) {\n        if (this.actors.raven.pos.x !== this.ravenDropPos.x && this.actors.raven.pos.y !== this.ravenDropPos.y) {\n          return this.actors.raven.moveXY(this.ravenDropPos.x, this.ravenDropPos.y);\n        } else {\n          this.world.gravity = 269.81;\n          p = this.instabuild(\"health-potion\", this.ravenDropPos.x, this.ravenDropPos.y);\n          p.pos.z = 9;\n          this.potionRegistry.push(p);\n          this.currentNumPotions++;\n          this.actorEvents[\"raven-swoop-progress\"] = true;\n          return this.actors.raven.moveXY(51, 54);\n        }\n      } else if (this.actorEvents[\"raven-swoop-progress\"]) {\n        if (this.actors.raven.pos.x === 51 && this.actors.raven.pos.y === 54 && !this.actorEvents[\"raven-swoop-return\"]) {\n          this.actorEvents[\"raven-swoop-return\"] = true;\n          return this.ravenPerch();\n        }\n      }\n    } else if (this.actorEvents[\"raven-swoop-start\"] && this.actorEvents[\"raven-swoop-return\"]) {\n      this.actorEvents[\"raven-swoop-start\"] = false;\n      this.actorEvents[\"raven-swoop-progress\"] = false;\n      return this.actorEvents[\"raven-swoop-return\"] = false;\n    }\n  };\n\n  StrandedInTheDunesReferee.prototype.checkPotions = function() {\n    var potions;\n    potions = this.findPotions();\n    if (potions.length < this.currentNumPotions) {\n      this.hero.health += this.hero.maxHealth / 2.5;\n      return this.currentNumPotions = potions.length;\n    }\n  };\n\n  StrandedInTheDunesReferee.prototype.findPotions = function() {\n    var potions;\n    potions = _.filter(this.potionRegistry, {\n      exists: true\n    });\n    return potions;\n  };\n\n  StrandedInTheDunesReferee.prototype.sectorPulse = function() {\n    var event, rect, skeleton, skeletons, spawnPoint, t, yak, yaks, _i, _j, _k, _l, _len, _len1, _len2, _len3, _len4, _m;\n    if (!this.disableEnemies && !this.bossStackGenerated) {\n      if (this.generateYakHerd()) {\n        yaks = (function() {\n          var _i, _len, _ref1, _results;\n          _ref1 = this.world.thangs;\n          _results = [];\n          for (_i = 0, _len = _ref1.length; _i < _len; _i++) {\n            t = _ref1[_i];\n            if (t.type === \"sand-yak\" && t !== this.actors.yakky && !t.dead) {\n              _results.push(t);\n            }\n          }\n          return _results;\n        }).call(this);\n        if (yaks.length === 0) {\n          this.assignWaveRegion(\"sand-yaks\", \"yak-herd\", new Rectangle(117, 30, 25.0, 25.0, 0));\n          this.spawnWaveNamed(\"sand-yaks\");\n          yaks = (function() {\n            var _i, _len, _ref1, _results;\n            _ref1 = this.world.thangs;\n            _results = [];\n            for (_i = 0, _len = _ref1.length; _i < _len; _i++) {\n              t = _ref1[_i];\n              if (t.isAttackable && t.type === \"sand-yak\" && t !== this.actors.yakky && t !== this.hero) {\n                _results.push(t);\n              }\n            }\n            return _results;\n          }).call(this);\n          for (_i = 0, _len = yaks.length; _i < _len; _i++) {\n            yak = yaks[_i];\n            this.configureYak(yak);\n            yak.move({\n              x: -14,\n              y: 30\n            });\n          }\n        } else {\n          this.createRectangle(\"yak-herd\", new Rectangle(117, 30, 25.0, 25.0, 0));\n          for (_j = 0, _len1 = yaks.length; _j < _len1; _j++) {\n            yak = yaks[_j];\n            this.configureYak(yak);\n            spawnPoint = this.pickPointFromRegions([this.rectangles[\"yak-herd\"]]);\n            yak.pos = spawnPoint;\n            yak.setExists(true);\n            yak.move({\n              x: -14,\n              y: 30\n            });\n          }\n        }\n        this.timers.sandYakTimer = 10;\n      }\n      event = this.chooseEvent();\n      if (event) {\n        rect = new Rectangle(this.hero.pos.x, 30, 45.0, 20.0, 0);\n        rect.x = Math.max(25, Math.min(90, rect.x));\n        if (event === \"melee-skeletons\") {\n          this.assignWaveRegion(\"melee-skeletons\", \"skeleton-attack\", rect);\n          this.spawnWaveNamed(\"melee-skeletons\");\n          skeletons = (function() {\n            var _k, _len2, _ref1, _results;\n            _ref1 = this.world.thangs;\n            _results = [];\n            for (_k = 0, _len2 = _ref1.length; _k < _len2; _k++) {\n              t = _ref1[_k];\n              if (t.isAttackable && t.type === \"brittle-skeleton\" && t.exists && t !== this.hero) {\n                _results.push(t);\n              }\n            }\n            return _results;\n          }).call(this);\n          for (_k = 0, _len2 = skeletons.length; _k < _len2; _k++) {\n            skeleton = skeletons[_k];\n            skeleton.attack(this.hero);\n          }\n          this.timers.eventTimer = 6;\n          return this.stackSpawns[this.currentStack]--;\n        } else if (event === \"shaman-skeleton\") {\n          this.assignWaveRegion(\"shaman-skeletons\", \"skeleton-attack\", rect);\n          this.spawnWaveNamed(\"shaman-skeletons\");\n          skeletons = (function() {\n            var _l, _len3, _ref1, _results;\n            _ref1 = this.world.thangs;\n            _results = [];\n            for (_l = 0, _len3 = _ref1.length; _l < _len3; _l++) {\n              t = _ref1[_l];\n              if (t.isAttackable && t.type === \"brittle-skeleton-shaman\" && t.exists && t !== this.hero) {\n                _results.push(t);\n              }\n            }\n            return _results;\n          }).call(this);\n          for (_l = 0, _len3 = skeletons.length; _l < _len3; _l++) {\n            skeleton = skeletons[_l];\n            skeleton.attack(this.hero);\n          }\n          this.timers.eventTimer = 6;\n          return this.stackSpawns[this.currentStack]--;\n        } else if (event === \"archer-skeletons\") {\n          this.assignWaveRegion(\"archer-skeletons\", \"skeleton-attack\", rect);\n          this.spawnWaveNamed(\"archer-skeletons\");\n          skeletons = (function() {\n            var _len4, _m, _ref1, _results;\n            _ref1 = this.world.thangs;\n            _results = [];\n            for (_m = 0, _len4 = _ref1.length; _m < _len4; _m++) {\n              t = _ref1[_m];\n              if (t.isAttackable && t.type === \"brittle-skeleton-archer\" && t.exists && t !== this.hero) {\n                _results.push(t);\n              }\n            }\n            return _results;\n          }).call(this);\n          for (_m = 0, _len4 = skeletons.length; _m < _len4; _m++) {\n            skeleton = skeletons[_m];\n            skeleton.attack(this.hero);\n          }\n          this.timers.eventTimer = 6;\n          return this.stackSpawns[this.currentStack]--;\n        }\n      }\n    }\n  };\n\n  StrandedInTheDunesReferee.prototype.generateYakHerd = function() {\n    var r;\n    if (!(this.timers.sandYakTimer <= 0 && this.currentSector() === \"sector1\")) {\n      return false;\n    }\n    r = Math.round(this.world.rand.randf2(1, 100));\n    return r >= this.eventOdds[\"sand-yaks\"];\n  };\n\n  StrandedInTheDunesReferee.prototype.chooseEvent = function() {\n    var r, r2;\n    if (!(this.timers.eventTimer <= 0 && this.stackSpawns[this.currentStack] > 0 && this.currentSector())) {\n      return false;\n    }\n    r = Math.round(this.world.rand.randf2(0, this.events.length - 1));\n    if (typeof this.events[r] !== \"undefined\") {\n      r2 = Math.round(this.world.rand.randf2(1, 100));\n      if (r2 >= this.eventOdds[this.events[r]]) {\n        return this.events[r];\n      }\n    }\n    return false;\n  };\n\n  StrandedInTheDunesReferee.prototype.currentSector = function() {\n    var sector, _i, _len, _ref1;\n    _ref1 = ['sector1', 'sector2', 'sector3'];\n    for (_i = 0, _len = _ref1.length; _i < _len; _i++) {\n      sector = _ref1[_i];\n      if (this.rectangles[sector].containsPoint(this.hero.pos)) {\n        return sector;\n      }\n    }\n    return false;\n  };\n\n  StrandedInTheDunesReferee.prototype.createRectangle = function(name, rect) {\n    return this.rectangles[name] = rect;\n  };\n\n  StrandedInTheDunesReferee.prototype.assignWaveRegion = function(wave, region, rect) {\n    this.createRectangle(region, rect);\n    return _.find(this.waves, {\n      name: wave\n    }).regions = [region];\n  };\n\n  StrandedInTheDunesReferee.prototype.fixUnitAggro = function() {\n    var skeleton, skeletons, t, yak, yaks, _i, _j, _len, _len1, _ref1, _results;\n    skeletons = (function() {\n      var _i, _len, _ref1, _results;\n      _ref1 = this.world.thangs;\n      _results = [];\n      for (_i = 0, _len = _ref1.length; _i < _len; _i++) {\n        t = _ref1[_i];\n        if (t.isAttackable && (t.type === \"brittle-skeleton\" || t.type === \"brittle-skeleton-shaman\") && t.exists && t !== this.hero) {\n          _results.push(t);\n        }\n      }\n      return _results;\n    }).call(this);\n    for (_i = 0, _len = skeletons.length; _i < _len; _i++) {\n      skeleton = skeletons[_i];\n      if (skeleton.target) {\n        if (!skeleton.target.exists || skeleton.target.dead) {\n          skeleton.setTarget(this.hero);\n        }\n      }\n    }\n    yaks = (function() {\n      var _j, _len1, _ref1, _results;\n      _ref1 = this.world.thangs;\n      _results = [];\n      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {\n        t = _ref1[_j];\n        if (t.isAttackable && t.type === \"sand-yak\" && t !== this.actors.yakky && t.exists && t !== this.hero) {\n          _results.push(t);\n        }\n      }\n      return _results;\n    }).call(this);\n    _results = [];\n    for (_j = 0, _len1 = yaks.length; _j < _len1; _j++) {\n      yak = yaks[_j];\n      if (yak.target) {\n        if (!yak.target.exists || yak.target.dead || yak.target.type === 'fire-trap') {\n          yak.setTarget(null);\n          yak.lastAttacker = null;\n          _results.push(yak.move({\n            x: -14,\n            y: 36\n          }));\n        } else {\n          _results.push(void 0);\n        }\n      } else if (((_ref1 = yak.targetPos) != null ? _ref1.x : void 0) > 0) {\n        _results.push(yak.move({\n          x: -14,\n          y: 36\n        }));\n      } else {\n        _results.push(void 0);\n      }\n    }\n    return _results;\n  };\n\n  StrandedInTheDunesReferee.prototype.cleanUpYaks = function(wipe) {\n    var t, yak, yaks, _i, _len, _results;\n    if (typeof wipe === \"undefined\") {\n      wipe = false;\n    }\n    yaks = (function() {\n      var _i, _len, _ref1, _results;\n      _ref1 = this.world.thangs;\n      _results = [];\n      for (_i = 0, _len = _ref1.length; _i < _len; _i++) {\n        t = _ref1[_i];\n        if (t.isAttackable && t.type === \"sand-yak\" && t.exists && t !== this.hero) {\n          _results.push(t);\n        }\n      }\n      return _results;\n    }).call(this);\n    _results = [];\n    for (_i = 0, _len = yaks.length; _i < _len; _i++) {\n      yak = yaks[_i];\n      if (yaks.length <= 5 || yak.pos.x <= 6 || wipe) {\n        _results.push(yak.setExists(false));\n      } else {\n        _results.push(void 0);\n      }\n    }\n    return _results;\n  };\n\n  StrandedInTheDunesReferee.prototype.cleanUpCorpses = function() {\n    var corpse, corpses, _i, _len, _results;\n    corpses = this.world.getSystem('Combat').corpses.slice();\n    _results = [];\n    for (_i = 0, _len = corpses.length; _i < _len; _i++) {\n      corpse = corpses[_i];\n      _results.push(corpse.setExists(false));\n    }\n    return _results;\n  };\n\n  StrandedInTheDunesReferee.prototype.spawnBossGuards = function() {\n    this.instabuild(\"brittle-skeleton\", 55, 8);\n    this.instabuild(\"brittle-skeleton\", 65, 8);\n    this.bossStartMarker = this.instabuild(\"x-mark-red\", 60, 15);\n    return this.createRectangle(\"boss-event-start\", new Rectangle(60, 15, 20.0, 10.0, 0));\n  };\n\n  StrandedInTheDunesReferee.prototype.bossEncounter = function() {\n    var newZ, pos, skeleton, skeletons, t, _base, _base1, _base10, _base11, _base12, _base13, _base2, _base3, _base4, _base5, _base6, _base7, _base8, _base9, _i, _len, _results;\n    if (this.bossStackGenerated) {\n      this.ravenMovement();\n      if (this.rectangles['boss-event-start'].containsPoint(this.hero.pos) && !this.bossEvents.started && this.enemiesCleared()) {\n        this.bossEvents.started = true;\n        this.actorEvents[\"raven-start-positioning\"] = true;\n        this.bossStartMarker.setExists(false);\n        this.bossEnv = this.instabuild(\"env\", 60, 35);\n        if (typeof (_base = this.bossEnv).say === \"function\") {\n          _base.say(\"*the ground begins to rumble*\");\n        }\n        return this.timers.bossDelay = 3;\n      } else if (this.bossEvents.started && !this.bossEvents.spawned && this.timers.bossDelay <= 0) {\n        this.bossEvents.spawned = true;\n        this.world.gravity = 269.81;\n        this.skeletonKing = this.instabuild(\"brittle-skeleton-king\", 60, 35, 'Skeleton King');\n        this.skeletonKing.pos.z = 30;\n        this.skeletonKing.isAttackable = false;\n        this.timers.bossfall = 0.1;\n        return this.bossFallModifier = 0.25;\n      } else if (this.bossEvents.spawned && this.timers.bossfall <= 0 && this.skeletonKing.pos.z > 0) {\n        this.timers.bossfall = 0.05;\n        newZ = this.skeletonKing.pos.z - this.bossFallModifier;\n        this.skeletonKing.pos.z = newZ < 0 ? 0 : newZ;\n        return this.bossFallModifier = this.bossFallModifier * 2;\n      } else if (this.bossEvents.spawned && !this.bossEvents.fallen && this.skeletonKing.pos.z <= 0) {\n        this.bossEvents.fallen = true;\n        return this.world.gravity = 9.81;\n      } else if (this.bossEvents.fallen && !this.bossEvents.dialog1) {\n        this.bossEvents.dialog1 = true;\n        this.timers.bossDelay = 5;\n        return typeof (_base1 = this.skeletonKing).sayWithDuration === \"function\" ? _base1.sayWithDuration(5.0, \"You have slain many of my minions and now must pay the price... in blood.\") : void 0;\n      } else if (this.bossEvents.dialog1 && !this.bossEvents.dialog2 && this.timers.bossDelay <= 0) {\n        this.bossEvents.dialog2 = true;\n        this.timers.bossDelay = 5;\n        return typeof (_base2 = this.skeletonKing).sayWithDuration === \"function\" ? _base2.sayWithDuration(5.0, \"You will not save Okar from his fate, but it will be amusing to watch you try!\") : void 0;\n      } else if (this.bossEvents.dialog2 && !this.bossEvents.moving && this.timers.bossDelay <= 0) {\n        this.bossEvents.moving = true;\n        this.skeletonKing.move({\n          x: 60,\n          y: 49\n        });\n        this.spawnAndAggroUnit(\"brittle-skeleton\", 47, 31, this.hero);\n        this.spawnAndAggroUnit(\"brittle-skeleton\", 52, 35, this.hero);\n        this.spawnAndAggroUnit(\"brittle-skeleton\", 57, 39, this.hero);\n        this.spawnAndAggroUnit(\"brittle-skeleton\", 62, 39, this.hero);\n        this.spawnAndAggroUnit(\"brittle-skeleton\", 67, 35, this.hero);\n        return this.spawnAndAggroUnit(\"brittle-skeleton\", 72, 31, this.hero);\n      } else if (this.bossEvents.moving && !this.bossEvents.positioned && Math.round(this.skeletonKing.pos.x) === 60 && Math.round(this.skeletonKing.pos.y) === 49) {\n        this.bossEvents.positioned = true;\n        this.timers.bossDelay = 4;\n        this.skeletonKing.rotation = 270;\n        return this.skeletonKing.setAction(null);\n      } else if (this.bossEvents.positioned && this.timers.bossDelay <= 0 && !this.bossEvents.wave1) {\n        this.bossEvents.wave1 = true;\n        this.timers.bossDelay = 5;\n        this.timers.swoopDelay = 7;\n        if (typeof (_base3 = this.skeletonKing).say === \"function\") {\n          _base3.say(\"Rise, my children, and protect me!\");\n        }\n        _.find(this.waves, {\n          name: \"archer-skeletons\"\n        }).scaledPower = 95.0;\n        this.assignWaveRegion(\"archer-skeletons\", \"boss-top-left\", new Rectangle(48, 51, 3.0, 3.0, 0));\n        this.spawnWaveNamed(\"archer-skeletons\");\n        _.find(this.waves, {\n          name: \"shaman-skeletons\"\n        }).scaledPower = 95.0;\n        this.assignWaveRegion(\"shaman-skeletons\", \"boss-top-right\", new Rectangle(70, 48, 3.0, 3.0, 0));\n        this.spawnWaveNamed(\"shaman-skeletons\");\n        skeletons = (function() {\n          var _i, _len, _ref1, _ref2, _results;\n          _ref1 = this.world.thangs;\n          _results = [];\n          for (_i = 0, _len = _ref1.length; _i < _len; _i++) {\n            t = _ref1[_i];\n            if (t.isAttackable && ((_ref2 = t.type) === \"brittle-skeleton-archer\" || _ref2 === \"brittle-skeleton-shaman\") && t.exists && t !== this.hero) {\n              _results.push(t);\n            }\n          }\n          return _results;\n        }).call(this);\n        _results = [];\n        for (_i = 0, _len = skeletons.length; _i < _len; _i++) {\n          skeleton = skeletons[_i];\n          _results.push(skeleton.attack(this.hero));\n        }\n        return _results;\n      } else if (this.bossEvents.wave1 && this.timers.swoopDelay <= 0 && !this.actorEvents[\"raven-swoop-start\"] && !this.actorEvents[\"raven-return-village\"]) {\n        this.actorEvents[\"raven-swoop-start\"] = true;\n        this.timers.swoopDelay = 17;\n        this.createRectangle(\"raven-drop-zone\", new Rectangle(60, 34, 12.0, 12.0, 0));\n        this.ravenDropPos = this.pickPointFromRegions([this.rectangles[\"raven-drop-zone\"]]);\n        return typeof (_base4 = this.actors.raven).sayWithDuration === \"function\" ? _base4.sayWithDuration(5.0, \"Hero, here's a little something to help out!\") : void 0;\n      } else if (this.bossEvents.wave1 && !this.bossEvents.taunt1 && this.enemiesCleared()) {\n        this.bossEvents.taunt1 = true;\n        if (typeof (_base5 = this.skeletonKing).sayWithDuration === \"function\") {\n          _base5.sayWithDuration(5.0, \"That was a nice warm-up. Let's see how you do with a real challenge.\");\n        }\n        return this.timers.bossDelay = 8;\n      } else if (this.bossEvents.taunt1 && !this.bossEvents.wave2 && this.timers.bossDelay <= 0) {\n        this.bossEvents.wave2 = true;\n        this.timers.bossDelay = 3;\n        this.spawnAndAggroUnit(\"brittle-skeleton\", 47, 33, this.hero);\n        this.spawnAndAggroUnit(\"brittle-skeleton\", 57, 25, this.hero);\n        this.spawnAndAggroUnit(\"brittle-skeleton\", 62, 25, this.hero);\n        return this.spawnAndAggroUnit(\"brittle-skeleton\", 72, 33, this.hero);\n      } else if (this.bossEvents.wave2 && !this.bossEvents.wave2_2 && this.timers.bossDelay <= 0) {\n        this.bossEvents.wave2_2 = true;\n        this.timers.bossDelay = 3;\n        if (typeof (_base6 = this.skeletonKing).say === \"function\") {\n          _base6.say(\"Rise, my children, and protect me!\");\n        }\n        _.find(this.waves, {\n          name: \"shaman-skeletons\"\n        }).scaledPower = 95.0;\n        this.assignWaveRegion(\"shaman-skeletons\", \"boss-bottom-left\", new Rectangle(41, 26, 3.0, 3.0, 0));\n        this.spawnWaveNamed(\"shaman-skeletons\");\n        _.find(this.waves, {\n          name: \"archer-skeletons\"\n        }).scaledPower = 95.0;\n        this.assignWaveRegion(\"archer-skeletons\", \"boss-bottom-right\", new Rectangle(79, 29, 3.0, 3.0, 0));\n        return this.spawnWaveNamed(\"archer-skeletons\");\n      } else if (this.bossEvents.wave2_2 && !this.bossEvents.wave2_3 && this.timers.bossDelay <= 0) {\n        this.bossEvents.wave2_3 = true;\n        if (typeof (_base7 = this.skeletonKing).say === \"function\") {\n          _base7.say(\"Rise, my children, and protect me!\");\n        }\n        _.find(this.waves, {\n          name: \"archer-skeletons\"\n        }).scaledPower = 95.0;\n        this.assignWaveRegion(\"archer-skeletons\", \"boss-top-left\", new Rectangle(48, 51, 3.0, 3.0, 0));\n        this.spawnWaveNamed(\"archer-skeletons\");\n        _.find(this.waves, {\n          name: \"shaman-skeletons\"\n        }).scaledPower = 95.0;\n        this.assignWaveRegion(\"shaman-skeletons\", \"boss-top-right\", new Rectangle(70, 48, 3.0, 3.0, 0));\n        return this.spawnWaveNamed(\"shaman-skeletons\");\n      } else if (this.bossEvents.wave2_3 && !this.bossEvents.taunt2 && this.enemiesCleared()) {\n        this.bossEvents.taunt2 = true;\n        if (typeof (_base8 = this.skeletonKing).sayWithDuration === \"function\") {\n          _base8.sayWithDuration(5.0, \"You are beginning to annoy me, frail one.\");\n        }\n        return this.timers.bossDelay = 8;\n      } else if (this.bossEvents.taunt2 && !this.bossEvents.wave3 && this.timers.bossDelay <= 0) {\n        this.bossEvents.wave3 = true;\n        this.timers.bossDelay = 8;\n        this.spawnAndAggroUnit(\"brittle-skeleton\", 81, 34, this.hero);\n        this.spawnAndAggroUnit(\"brittle-skeleton\", 75, 23, this.hero);\n        this.spawnAndAggroUnit(\"brittle-skeleton\", 83, 24, this.hero);\n        this.spawnAndAggroUnit(\"brittle-skeleton\", 74, 31, this.hero);\n        return this.spawnAndAggroUnit(\"brittle-skeleton-archer\", 79, 29, this.hero);\n      } else if (this.bossEvents.wave3 && !this.bossEvents.wave3_1 && this.timers.bossDelay <= 0) {\n        this.bossEvents.wave3_1 = true;\n        this.timers.bossDelay = 8;\n        this.spawnAndAggroUnit(\"brittle-skeleton\", 39, 32, this.hero);\n        this.spawnAndAggroUnit(\"brittle-skeleton\", 45, 24, this.hero);\n        this.spawnAndAggroUnit(\"brittle-skeleton\", 38, 25, this.hero);\n        this.spawnAndAggroUnit(\"brittle-skeleton\", 46, 32, this.hero);\n        return this.spawnAndAggroUnit(\"brittle-skeleton-archer\", 42, 28, this.hero);\n      } else if (this.bossEvents.wave3_1 && !this.bossEvents.wave3_2 && this.timers.bossDelay <= 0) {\n        this.bossEvents.wave3_2 = true;\n        this.timers.bossDelay = 8;\n        if (typeof (_base9 = this.skeletonKing).say === \"function\") {\n          _base9.say(\"Rise, my children, and protect me!\");\n        }\n        _.find(this.waves, {\n          name: \"archer-skeletons\"\n        }).scaledPower = 95.0;\n        this.assignWaveRegion(\"archer-skeletons\", \"boss-top-left\", new Rectangle(48, 51, 3.0, 3.0, 0));\n        this.spawnWaveNamed(\"archer-skeletons\");\n        _.find(this.waves, {\n          name: \"shaman-skeletons\"\n        }).scaledPower = 95.0;\n        this.assignWaveRegion(\"shaman-skeletons\", \"boss-top-right\", new Rectangle(70, 48, 3.0, 3.0, 0));\n        return this.spawnWaveNamed(\"shaman-skeletons\");\n      } else if (this.bossEvents.wave3_2 && !this.bossEvents.wave3_3 && this.timers.bossDelay <= 0) {\n        this.bossEvents.wave3_3 = true;\n        this.timers.bossDelay = 8;\n        if (typeof (_base10 = this.skeletonKing).say === \"function\") {\n          _base10.say(\"Rise, my children, and protect me!\");\n        }\n        _.find(this.waves, {\n          name: \"archer-skeletons\"\n        }).scaledPower = 95.0;\n        this.assignWaveRegion(\"archer-skeletons\", \"boss-bottom-left\", new Rectangle(41, 26, 3.0, 3.0, 0));\n        this.spawnWaveNamed(\"archer-skeletons\");\n        _.find(this.waves, {\n          name: \"archer-skeletons\"\n        }).scaledPower = 95.0;\n        this.assignWaveRegion(\"archer-skeletons\", \"boss-bottom-right\", new Rectangle(79, 29, 3.0, 3.0, 0));\n        return this.spawnWaveNamed(\"archer-skeletons\");\n      } else if (this.bossEvents.wave3_3 && !this.bossEvents.king && this.timers.bossDelay <= 0) {\n        this.bossEvents.king = true;\n        this.timers.bossDelay = 8;\n        if (typeof (_base11 = this.skeletonKing).say === \"function\") {\n          _base11.say(\"It would appear I have to do everything myself!\");\n        }\n        _.find(this.waves, {\n          name: \"shaman-skeletons\"\n        }).scaledPower = 95.0;\n        this.assignWaveRegion(\"shaman-skeletons\", \"boss-top-left\", new Rectangle(48, 51, 3.0, 3.0, 0));\n        this.spawnWaveNamed(\"shaman-skeletons\");\n        _.find(this.waves, {\n          name: \"shaman-skeletons\"\n        }).scaledPower = 95.0;\n        this.assignWaveRegion(\"shaman-skeletons\", \"boss-top-right\", new Rectangle(70, 48, 3.0, 3.0, 0));\n        this.spawnWaveNamed(\"shaman-skeletons\");\n        this.skeletonKing.isAttackable = true;\n        return this.skeletonKing.attack(this.hero);\n      } else if (this.bossEvents.king && !this.bossEvents.son1 && this.enemiesCleared()) {\n        this.actorEvents[\"raven-return-village\"] = true;\n        this.bossEvents.son1 = true;\n        this.actors.son.setExists(true);\n        this.actors.son.pos.x = 47;\n        this.actors.son.pos.y = 67;\n        this.actors.son.moveXY(47, 52);\n        return this.world.setGoalState('kill-skeleton-king', 'success');\n      } else if (this.bossEvents.son1 && !this.bossEvents.son2 && this.actors.son.pos.x === 47 && this.actors.son.pos.y === 52) {\n        this.bossEvents.son2 = true;\n        pos = Vector.subtract(this.actors.son.pos, this.hero.pos).normalize().multiply(7).add(this.hero.pos);\n        return this.actors.son.moveXY(pos.x, pos.y);\n      } else if (this.bossEvents.son2 && !this.bossEvents.sonDialog && this.actors.son.pos.x >= (this.hero.pos.x - 7) && this.actors.son.pos.y >= (this.hero.pos.y - 7)) {\n        this.bossEvents.sonDialog = true;\n        this.timers.bossDelay = 3;\n        this.actors.son.velocity.multiply(0);\n        this.actors.son.setAction(null);\n        this.actors.son.setTarget(null);\n        return typeof (_base12 = this.actors.son).say === \"function\" ? _base12.say(\"Thank you for saving me! Let's return to the village!\") : void 0;\n      } else if (this.bossEvents.sonDialog && this.timers.bossDelay <= 0 && !this.bossEvents.returnVillage1) {\n        this.bossEvents.returnVillage1 = true;\n        this.currentStack = 0;\n        this.configureStack();\n        this.actors.raven.pos.x = 60.5;\n        this.actors.raven.pos.y = 41;\n        this.hero.pos.x = 36;\n        this.hero.pos.y = 28;\n        this.hero.rotation = 90;\n        this.actors.son.pos.x = 28;\n        return this.actors.son.pos.y = 26;\n      } else if (this.bossEvents.returnVillage1 && !this.bossEvents.returnVillage2) {\n        this.bossEvents.returnVillage2 = true;\n        return typeof (_base13 = this.actors.elder).say === \"function\" ? _base13.say(\"We are in forever in your debt, great champion. Many blessings!\") : void 0;\n      }\n    }\n  };\n\n  StrandedInTheDunesReferee.prototype.spawnAndAggroUnit = function(unit, x, y, target) {\n    var u;\n    u = this.instabuild(unit, x, y);\n    return u.attack(target);\n  };\n\n  StrandedInTheDunesReferee.prototype.populateTerrain = function(boss) {\n    var i, obj, objs, r, r2, stack, t, terrain, x, y, _i, _j, _k, _l, _len, _len1, _len2, _m, _ref1, _ref2;\n    if (typeof boss === \"undefined\") {\n      boss = false;\n    }\n    _ref1 = this.terrainCleanupObjects;\n    for (i = _i = 0, _len = _ref1.length; _i < _len; i = ++_i) {\n      terrain = _ref1[i];\n      terrain = (terrain.split('-').map(function(word) {\n        return word[0].toUpperCase() + word.slice(1).toLowerCase();\n      })).join(' ');\n      objs = (function() {\n        var _j, _len1, _ref2, _results;\n        _ref2 = this.world.thangs;\n        _results = [];\n        for (_j = 0, _len1 = _ref2.length; _j < _len1; _j++) {\n          t = _ref2[_j];\n          if (t.spriteName === terrain && t.exists) {\n            _results.push(t);\n          }\n        }\n        return _results;\n      }).call(this);\n      for (i = _j = 0, _len1 = objs.length; _j < _len1; i = ++_j) {\n        obj = objs[i];\n        obj.setExists(false);\n      }\n    }\n    if (boss) {\n      this.terrainStack[this.currentStack] = this.bossStack;\n      this.stackSpawns[this.currentStack] = 0;\n    }\n    if (typeof this.terrainStack[this.currentStack] !== \"undefined\") {\n      _ref2 = this.terrainStack[this.currentStack];\n      for (i = _k = 0, _len2 = _ref2.length; _k < _len2; i = ++_k) {\n        stack = _ref2[i];\n        t = this.instabuild(stack.obj, stack.x, stack.y);\n        if (typeof stack.r !== \"undefined\") {\n          t.rotation = stack.r;\n          t.addTrackedProperties(['rotation', 'number']);\n          t.keepTrackedProperty('rotation');\n        }\n        if (typeof stack.c !== \"undefined\") {\n          t.cancelCollisions();\n        }\n        t.stateless = false;\n      }\n    } else {\n      stack = [];\n      r = Math.round(this.world.rand.randf2(this.maxNumTerrainObjects / 2, this.maxNumTerrainObjects));\n      for (i = _l = 1; _l <= r; i = _l += 1) {\n        r2 = Math.round(this.world.rand.randf2(0, this.terrainObjects.length - 1));\n        x = Math.round(this.world.rand.randf2(15, 105));\n        if (this.world.rand.randf() < 0.5) {\n          y = Math.round(this.world.rand.randf2(0, 15));\n        } else {\n          y = Math.round(this.world.rand.randf2(45, 65));\n        }\n        stack.push({\n          obj: this.terrainObjects[r2],\n          x: x,\n          y: y\n        });\n        t = this.instabuild(this.terrainObjects[r2], x, y);\n        t.stateless = false;\n      }\n      r = Math.round(this.world.rand.randf2(0, this.maxNumFireTraps));\n      for (i = _m = 1; _m <= r; i = _m += 1) {\n        x = Math.round(this.world.rand.randf2(15, 105));\n        y = Math.round(this.world.rand.randf2(15, 55));\n        stack.push({\n          obj: \"fire-trap\",\n          x: x,\n          y: y\n        });\n        t = this.instabuild(\"fire-trap\", x, y);\n        t.stateless = false;\n      }\n      this.terrainStack.push(stack);\n    }\n    return this.world.getSystem(\"AI\").onObstaclesChanged();\n  };\n\n  StrandedInTheDunesReferee.prototype.enemiesCleared = function() {\n    var t, units;\n    units = (function() {\n      var _i, _len, _ref1, _results;\n      _ref1 = this.world.thangs;\n      _results = [];\n      for (_i = 0, _len = _ref1.length; _i < _len; _i++) {\n        t = _ref1[_i];\n        if (t.isAttackable && t.team !== \"humans\" && t.type !== \"sand-yak\" && t.exists && !t.dead && t !== this.actors.raven && t !== this.hero) {\n          _results.push(t);\n        }\n      }\n      return _results;\n    }).call(this);\n    return units.length < 1 && this.stackSpawns[this.currentStack] === 0;\n  };\n\n  StrandedInTheDunesReferee.prototype.handleLevelWrap = function() {\n    if (this.enemiesCleared()) {\n      if (this.leftWrapPending && this.timers.wrapTimer <= 0) {\n        this.currentStack++;\n        if (typeof this.stackSpawns[this.currentStack] === \"undefined\") {\n          this.stackSpawns[this.currentStack] = this.numberOfEvents;\n        }\n        this.actorEvents[\"raven-spawned\"] = false;\n        this.cleanUpYaks(true);\n        this.configureStack();\n        if (this.hero.action === \"move\" && this.hero.targetPos) {\n          this.hero.targetPos.x = 6;\n        }\n        this.hero.pos.x = 6;\n        this.leftWrapPending = false;\n      }\n      if (this.rightWrapPending && this.timers.wrapTimer <= 0) {\n        if (this.currentStack > 0) {\n          this.currentStack--;\n          this.actorEvents[\"raven-spawned\"] = false;\n          this.cleanUpYaks(true);\n          this.configureStack();\n          if (this.hero.action === \"move\" && this.hero.targetPos) {\n            this.hero.targetPos.x = 115;\n          }\n          this.hero.pos.x = 115;\n        }\n        this.rightWrapPending = false;\n      }\n      if (this.rectangles['wrap-point'].containsPoint(this.hero.pos) && this.timers.wrapTimer <= 0 && !this.leftWrapPending && !this.bossStackGenerated) {\n        this.timers.wrapTimer = 0;\n        return this.leftWrapPending = true;\n      } else if (this.rectangles['wrap-point2'].containsPoint(this.hero.pos) && this.timers.wrapTimer <= 0 && !this.rightWrapPending) {\n        this.timers.wrapTimer = 0;\n        return this.rightWrapPending = true;\n      }\n    }\n  };\n\n  StrandedInTheDunesReferee.prototype.checkVictory = function() {\n    if (this.bossEvents.returnVillage2) {\n      return this.setGoalState('hero-survive', 'success');\n    }\n  };\n\n  return StrandedInTheDunesReferee;\n\n})(Component);\n",
	"system": "misc",
	"creator": "549e3388026077f70ae5317a",
	"original": "54c83ff20fe0695205fb410b",
	"watchers": [
		"546d4b4fa06acfd60c5ea198",
		"512ef4805a67a8c507000001",
		"5162fab9c92b4c751e000274"
	],
	"__v": 0,
	"commitMessage": "Made the skeleton king's text reflect the use of Okar instead of \"the girl\"",
	"index": true,
	"parent": "55e8d99fee10a44a102dde34",
	"created": "2015-10-19T15:37:12.492Z",
	"version": {
		"isLatestMinor": true,
		"isLatestMajor": true,
		"minor": 126,
		"major": 0
	},
	"permissions": [
		{
			"access": "owner",
			"target": "546d4b4fa06acfd60c5ea198"
		},
		{
			"access": "read",
			"target": "public"
		}
	]
}